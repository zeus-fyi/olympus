name: Build Hydra Choreography App

on:
  push:
    paths:
      - apps/olympus/choreography/hydra/**
    branches:
      - main
env:
  AWS_REGION: us-west-1
  GO111MODULE: on
  GOOS: linux
  GOARCH: amd64
  CGO_ENABLED: 1
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Docker
      uses: docker/setup-docker-action@v1
      with:
        context: /github/workspace

    - name: Clone external repos into workspace
      run: |
        mkdir -p apps/external
        cd apps/external
        git clone https://github.com/zeus-fyi/web3.git --branch master --single-branch
        git clone https://github.com/zeus-fyi/tables-to-go.git --branch master --single-branch
        git clone https://github.com/zeus-fyi/jennifer.git --branch master --single-branch
        git clone https://github.com/zeus-fyi/tojen.git --branch master --single-branch
        git clone https://github.com/zeus-fyi/memoryfs.git --branch master --single-branch

    - name: Install dependencies
      run: |
        mkdir -p /home/github/bin
        wget https://github.com/digitalocean/doctl/releases/download/v1.78.0/doctl-1.78.0-linux-amd64.tar.gz -O doctl.tar.gz
        tar xf doctl.tar.gz -C /home/github/bin

    - name: Cache Go Modules
      uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: go-mod-${{ hashFiles('**/go.sum') }}

    - name: Build And Publish Hydra Choreography App
      run: |
        doctl registry login -t ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        cd makefiles/hydra/Makefile
        make docker.pubbuildx
